<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel Blocking Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { 
            padding: 20px; 
            background: #f8f9fa;
            font-size: 14px;
        }
        .header-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .filters {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stats-row {
            background: #e7f3ff;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        .table-container {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        table {
            font-size: 13px;
            white-space: nowrap;
        }
        td.editable {
            cursor: pointer;
            position: relative;
        }
        td.editable:hover {
            background: #f0f8ff;
        }
        td.editable.selected {
            outline: 2px solid #0d6efd;
            outline-offset: -2px;
        }
        td.editing {
            padding: 0 !important;
            background: #e3f2fd !important;
        }
        td.editing input, td.editing select {
            width: 100%;
            border: 2px solid #0d6efd;
            padding: 4px 8px;
            font-size: 13px;
            box-sizing: border-box;
        }
        .status-blocked { background: #ffc107; color: #000; }
        .status-confirmed { background: #28a745; color: #fff; }
        .status-cancellation { background: #ff9800; color: #fff; }
        .status-cancelled { background: #dc3545; color: #fff; }
        .deadline-warning { 
            background-color: #fff3cd !important;
        }
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .price-cell {
            text-align: right;
            font-family: monospace;
        }
        .comment-indicator {
            color: #0d6efd;
            cursor: pointer;
        }
        .comment-indicator:hover {
            color: #0a58ca;
        }
        .date-preset-btn {
            font-size: 0.75rem;
            padding: 0.2rem 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="header-section">
            <div class="d-flex justify-content-between align-items-center">
                <h3>Hotel Blocking Tracker</h3>
                <div>
                    <button class="btn btn-success btn-sm" onclick="exportData()">
                        <i class="bi bi-download"></i> Export
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="document.getElementById('importFile').click()">
                        <i class="bi bi-upload"></i> Import
                    </button>
                    <input type="file" id="importFile" style="display:none" accept=".json" onchange="importData(event)">
                </div>
            </div>
        </div>

        <div class="filters">
            <div class="row g-2 mb-2">
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm" id="filterTourCode" placeholder="Tour Code" onkeyup="applyFilters()">
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm" id="filterCountry" onchange="applyFilters()">
                        <option value="">All Countries</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm" id="filterCity" onchange="applyFilters()">
                        <option value="">All Cities</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm" id="filterHotel" placeholder="Hotel Name" onkeyup="applyFilters()">
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm" id="filterStatus" onchange="applyFilters()">
                        <option value="">All Status</option>
                        <option value="blocked">Blocked</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="cancellation">Cancellation</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-sm btn-outline-secondary w-100" onclick="clearFilters()">
                        <i class="bi bi-x-circle"></i> Clear All
                    </button>
                </div>
            </div>
            <div class="row g-2 align-items-center">
                <div class="col-md-2">
                    <label class="form-label mb-0 small">Canx Deadline From:</label>
                    <input type="date" class="form-control form-control-sm" id="filterCanxFrom" onchange="applyFilters()">
                </div>
                <div class="col-md-2">
                    <label class="form-label mb-0 small">Canx Deadline To:</label>
                    <input type="date" class="form-control form-control-sm" id="filterCanxTo" onchange="applyFilters()">
                </div>
                <div class="col-md-8">
                    <label class="form-label mb-0 small">Quick Presets:</label>
                    <div>
                        <button class="btn btn-outline-primary date-preset-btn me-1" onclick="setDatePreset(3)">Next 3 Days</button>
                        <button class="btn btn-outline-primary date-preset-btn me-1" onclick="setDatePreset(7)">Next 7 Days</button>
                        <button class="btn btn-outline-primary date-preset-btn me-1" onclick="setDatePreset(30)">Next 30 Days</button>
                        <button class="btn btn-outline-secondary date-preset-btn" onclick="clearDateFilter()">Clear Dates</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-row">
            <div class="row text-center">
                <div class="col">
                    <strong>Total Bookings:</strong> <span id="statTotal">0</span>
                </div>
                <div class="col">
                    <strong>Total Rooms:</strong> <span id="statRooms">0</span>
                </div>
                <div class="col">
                    <strong>Blocked:</strong> <span id="statBlocked">0</span>
                </div>
                <div class="col">
                    <strong>Confirmed:</strong> <span id="statConfirmed">0</span>
                </div>
                <div class="col">
                    <strong>Cancellation:</strong> <span id="statCancellation">0</span>
                </div>
                <div class="col">
                    <strong>Cancelled:</strong> <span id="statCancelled">0</span>
                </div>
            </div>
        </div>

        <div class="mb-2">
            <button class="btn btn-primary btn-sm" onclick="addNewRow()">
                <i class="bi bi-plus-circle"></i> Add Booking
            </button>
        </div>

        <div class="table-container">
            <table class="table table-sm table-hover table-bordered" id="mainTable">
                <thead class="table-light">
                    <tr>
                        <th>Tour Code</th>
                        <th>Country</th>
                        <th>City</th>
                        <th>Hotel</th>
                        <th>Check-in</th>
                        <th>Check-out</th>
                        <th>Rooms Config</th>
                        <th>Single PPPN</th>
                        <th>Double PPPN</th>
                        <th>Triple PPPN</th>
                        <th>CWB</th>
                        <th>CNB</th>
                        <th>Dinner Cost</th>
                        <th>Status</th>
                        <th>Canx Deadline</th>
                        <th>Comments</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="mainTableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Comments Modal -->
    <div class="modal fade" id="commentsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Comments</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <textarea class="form-control" id="commentsText" rows="6"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="saveComments()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const countries = {
            'France': ['Paris', 'Nice', 'Lyon', 'Marseille'],
            'Italy': ['Rome', 'Venice', 'Florence', 'Milan'],
            'Spain': ['Barcelona', 'Madrid', 'Seville', 'Valencia'],
            'Germany': ['Berlin', 'Munich', 'Frankfurt', 'Hamburg'],
            'Netherlands': ['Amsterdam', 'Rotterdam', 'The Hague', 'Utrecht'],
            'Belgium': ['Brussels', 'Bruges', 'Antwerp', 'Ghent'],
            'Austria': ['Vienna', 'Salzburg', 'Innsbruck', 'Graz'],
            'Switzerland': ['Zurich', 'Geneva', 'Lucerne', 'Interlaken'],
            'Czech Republic': ['Prague', 'Cesky Krumlov', 'Brno', 'Karlovy Vary'],
            'Portugal': ['Lisbon', 'Porto', 'Faro', 'Sintra'],
            'Greece': ['Athens', 'Santorini', 'Mykonos', 'Crete'],
            'Poland': ['Warsaw', 'Krakow', 'Gdansk', 'Wroclaw'],
            'Hungary': ['Budapest', 'Eger', 'Pecs', 'Debrecen'],
            'Denmark': ['Copenhagen', 'Aarhus', 'Odense', 'Aalborg'],
            'Sweden': ['Stockholm', 'Gothenburg', 'Malmo', 'Uppsala'],
            'Norway': ['Oslo', 'Bergen', 'Trondheim', 'Stavanger'],
            'Finland': ['Helsinki', 'Tampere', 'Turku', 'Rovaniemi'],
            'Iceland': ['Reykjavik', 'Akureyri', 'Vik', 'Hofn'],
            'UK': ['London', 'Edinburgh', 'Manchester', 'Liverpool']
        };

        let bookings = [];
        let selectedCell = null;
        let isEditing = false;
        let currentCommentId = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            populateFilters();
            renderTable();
            setupGlobalKeyListener();
        });

        function setupGlobalKeyListener() {
            document.addEventListener('keydown', function(e) {
                // Ignore if typing in filter inputs or modal
                if (e.target.tagName === 'INPUT' && !e.target.closest('td.editing')) return;
                if (e.target.tagName === 'TEXTAREA') return;
                if (e.target.tagName === 'SELECT' && !e.target.closest('td.editing')) return;
                if (document.querySelector('.modal.show')) return;

                // If editing, handle navigation keys
                if (isEditing) return;

                // Arrow key navigation
                if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                    e.preventDefault();
                    navigateWithArrows(e.key);
                }
                // Any other key - start editing
                else if (selectedCell && !e.ctrlKey && !e.metaKey && e.key.length === 1) {
                    e.preventDefault();
                    selectedCell.click();
                    // The keypress will be captured by the input
                    setTimeout(() => {
                        const input = selectedCell.querySelector('input, select');
                        if (input && input.tagName === 'INPUT') {
                            input.value = e.key;
                        }
                    }, 10);
                }
            });
        }

        function navigateWithArrows(direction) {
            if (!selectedCell) return;

            const allCells = Array.from(document.querySelectorAll('td.editable'));
            const currentIndex = allCells.indexOf(selectedCell);
            if (currentIndex === -1) return;

            const currentRow = selectedCell.parentElement;
            const rowCells = Array.from(currentRow.querySelectorAll('td.editable'));
            const cellIndexInRow = rowCells.indexOf(selectedCell);

            let nextCell = null;

            if (direction === 'ArrowLeft') {
                nextCell = rowCells[cellIndexInRow - 1];
            } else if (direction === 'ArrowRight') {
                nextCell = rowCells[cellIndexInRow + 1];
            } else if (direction === 'ArrowUp') {
                const prevRow = currentRow.previousElementSibling;
                if (prevRow) {
                    const prevRowCells = Array.from(prevRow.querySelectorAll('td.editable'));
                    nextCell = prevRowCells[cellIndexInRow];
                }
            } else if (direction === 'ArrowDown') {
                const nextRow = currentRow.nextElementSibling;
                if (nextRow) {
                    const nextRowCells = Array.from(nextRow.querySelectorAll('td.editable'));
                    nextCell = nextRowCells[cellIndexInRow];
                }
            }

            if (nextCell) {
                selectCell(nextCell);
            }
        }

        function selectCell(cell) {
            if (selectedCell) {
                selectedCell.classList.remove('selected');
            }
            selectedCell = cell;
            cell.classList.add('selected');
        }

        function populateFilters() {
            const countrySelect = document.getElementById('filterCountry');
            const citySelect = document.getElementById('filterCity');
            
            Object.keys(countries).sort().forEach(country => {
                countrySelect.innerHTML += `<option value="${country}">${country}</option>`;
            });

            Object.values(countries).flat().sort().forEach(city => {
                citySelect.innerHTML += `<option value="${city}">${city}</option>`;
            });
        }

        function setDatePreset(days) {
            const today = new Date();
            const futureDate = new Date();
            futureDate.setDate(today.getDate() + days);

            document.getElementById('filterCanxFrom').value = today.toISOString().split('T')[0];
            document.getElementById('filterCanxTo').value = futureDate.toISOString().split('T')[0];
            applyFilters();
        }

        function clearDateFilter() {
            document.getElementById('filterCanxFrom').value = '';
            document.getElementById('filterCanxTo').value = '';
            applyFilters();
        }

        function addNewRow() {
            const newBooking = {
                id: Date.now().toString(),
                tourCode: '',
                country: '',
                city: '',
                hotelName: '',
                checkIn: '',
                checkOut: '',
                roomsConfig: '',
                singlePPPN: '',
                doublePPPN: '',
                triplePPPN: '',
                cwb: '',
                cnb: '',
                dinnerCost: '',
                status: 'blocked',
                cancellationDeadline: '',
                comments: ''
            };
            bookings.unshift(newBooking);
            saveData();
            renderTable();
            
            // Auto-select first field after render
            setTimeout(() => {
                const firstCell = document.querySelector('tbody tr:first-child td.editable');
                if (firstCell) {
                    selectCell(firstCell);
                }
            }, 50);
        }

        function renderTable() {
            const tbody = document.getElementById('mainTableBody');
            const filteredBookings = getFilteredBookings();
            
            if (filteredBookings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="17" class="text-center text-muted">No bookings found</td></tr>';
                updateStats(filteredBookings);
                return;
            }

            const today = new Date();
            const sevenDaysFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);

            tbody.innerHTML = filteredBookings.map(booking => {
                const canxDeadline = booking.cancellationDeadline ? new Date(booking.cancellationDeadline) : null;
                const isWarning = canxDeadline && canxDeadline >= today && canxDeadline <= sevenDaysFromNow;
                const hasComments = booking.comments && booking.comments.trim() !== '';
                
                return `
                    <tr class="${isWarning ? 'deadline-warning' : ''}" data-id="${booking.id}">
                        <td class="editable" data-field="tourCode" onclick="handleCellClick(this, '${booking.id}', 'tourCode', 'text')">${booking.tourCode || '-'}</td>
                        <td class="editable" data-field="country" onclick="handleCellClick(this, '${booking.id}', 'country', 'select-country')">${booking.country || '-'}</td>
                        <td class="editable" data-field="city" onclick="handleCellClick(this, '${booking.id}', 'city', 'select-city')">${booking.city || '-'}</td>
                        <td class="editable" data-field="hotelName" onclick="handleCellClick(this, '${booking.id}', 'hotelName', 'text')">${booking.hotelName || '-'}</td>
                        <td class="editable" data-field="checkIn" onclick="handleCellClick(this, '${booking.id}', 'checkIn', 'date')">${formatDate(booking.checkIn)}</td>
                        <td class="editable" data-field="checkOut" onclick="handleCellClick(this, '${booking.id}', 'checkOut', 'date')">${formatDate(booking.checkOut)}</td>
                        <td class="editable" data-field="roomsConfig" onclick="handleCellClick(this, '${booking.id}', 'roomsConfig', 'text')">${booking.roomsConfig || '-'}</td>
                        <td class="editable price-cell" data-field="singlePPPN" onclick="handleCellClick(this, '${booking.id}', 'singlePPPN', 'number')">€${booking.singlePPPN || '-'}</td>
                        <td class="editable price-cell" data-field="doublePPPN" onclick="handleCellClick(this, '${booking.id}', 'doublePPPN', 'number')">€${booking.doublePPPN || '-'}</td>
                        <td class="editable price-cell" data-field="triplePPPN" onclick="handleCellClick(this, '${booking.id}', 'triplePPPN', 'number')">€${booking.triplePPPN || '-'}</td>
                        <td class="editable price-cell" data-field="cwb" onclick="handleCellClick(this, '${booking.id}', 'cwb', 'number')">€${booking.cwb || '-'}</td>
                        <td class="editable price-cell" data-field="cnb" onclick="handleCellClick(this, '${booking.id}', 'cnb', 'number')">€${booking.cnb || '-'}</td>
                        <td class="editable price-cell" data-field="dinnerCost" onclick="handleCellClick(this, '${booking.id}', 'dinnerCost', 'number')">€${booking.dinnerCost || '-'}</td>
                        <td class="editable" data-field="status" onclick="handleCellClick(this, '${booking.id}', 'status', 'select-status')">
                            <span class="badge status-${booking.status}">${booking.status.charAt(0).toUpperCase() + booking.status.slice(1)}</span>
                        </td>
                        <td class="editable" data-field="cancellationDeadline" onclick="handleCellClick(this, '${booking.id}', 'cancellationDeadline', 'date')">${formatDate(booking.cancellationDeadline)}</td>
                        <td class="text-center">
                            <i class="bi bi-chat-square-text comment-indicator ${hasComments ? 'text-primary' : 'text-muted'}" 
                               onclick="openComments('${booking.id}')"></i>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteBooking('${booking.id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            updateStats(filteredBookings);
        }

        function handleCellClick(cell, id, field, type) {
            selectCell(cell);
            editCell(cell, id, field, type);
        }

        function editCell(cell, id, field, type) {
            if (isEditing) return;
            
            isEditing = true;
            const booking = bookings.find(b => b.id === id);
            const currentValue = booking[field] || '';
            
            cell.classList.add('editing');
            cell.classList.remove('selected');
            
            let inputHTML = '';
            if (type === 'text') {
                inputHTML = `<input type="text" value="${currentValue}" data-id="${id}" data-field="${field}">`;
            } else if (type === 'date') {
                inputHTML = `<input type="date" value="${currentValue}" data-id="${id}" data-field="${field}">`;
            } else if (type === 'number') {
                inputHTML = `<input type="number" step="0.01" value="${currentValue}" data-id="${id}" data-field="${field}">`;
            } else if (type === 'select-status') {
                inputHTML = `
                    <select data-id="${id}" data-field="${field}">
                        <option value="blocked" ${currentValue === 'blocked' ? 'selected' : ''}>Blocked</option>
                        <option value="confirmed" ${currentValue === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                        <option value="cancellation" ${currentValue === 'cancellation' ? 'selected' : ''}>Cancellation</option>
                        <option value="cancelled" ${currentValue === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                    </select>
                `;
            } else if (type === 'select-country') {
                inputHTML = `
                    <select data-id="${id}" data-field="${field}">
                        <option value="">-</option>
                        ${Object.keys(countries).sort().map(c => 
                            `<option value="${c}" ${currentValue === c ? 'selected' : ''}>${c}</option>`
                        ).join('')}
                    </select>
                `;
            } else if (type === 'select-city') {
                inputHTML = `
                    <select data-id="${id}" data-field="${field}">
                        <option value="">-</option>
                        ${Object.values(countries).flat().sort().map(c => 
                            `<option value="${c}" ${currentValue === c ? 'selected' : ''}>${c}</option>`
                        ).join('')}
                    </select>
                `;
            }
            
            cell.innerHTML = inputHTML;
            const input = cell.querySelector('input, select');
            input.focus();

            // Setup event listeners
            input.addEventListener('blur', function() {
                saveAndExit(this);
            });

            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveAndExit(this);
                } else if (e.key === 'Tab') {
                    e.preventDefault();
                    const moveBackward = e.shiftKey;
                    saveAndNavigate(this, moveBackward);
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelEdit(cell);
                }
            });

            // For selects, auto-save on change
            if (input.tagName === 'SELECT') {
                input.addEventListener('change', function() {
                    saveAndExit(this);
                });
            }
        }

        function saveAndExit(input) {
            const id = input.dataset.id;
            const field = input.dataset.field;
            const value = input.value;
            
            const booking = bookings.find(b => b.id === id);
            booking[field] = value;
            
            saveData();
            isEditing = false;
            renderTable();
        }

        function saveAndNavigate(input, backward = false) {
            const id = input.dataset.id;
            const field = input.dataset.field;
            const value = input.value;
            
            const booking = bookings.find(b => b.id === id);
            booking[field] = value;
            
            saveData();
            isEditing = false;

            const cell = input.closest('td');
            const row = cell.parentElement;
            const rowCells = Array.from(row.querySelectorAll('td.editable'));
            const currentIndex = rowCells.indexOf(cell);
            
            const nextIndex = backward ? currentIndex - 1 : currentIndex + 1;
            
            renderTable();

            setTimeout(() => {
                const newRow = document.querySelector(`tr[data-id="${id}"]`);
                if (newRow) {
                    const newRowCells = Array.from(newRow.querySelectorAll('td.editable'));
                    const nextCell = newRowCells[nextIndex];
                    if (nextCell) {
                        nextCell.click();
                    }
                }
            }, 50);
        }

        function cancelEdit(cell) {
            isEditing = false;
            renderTable();
        }

        function openComments(id) {
            currentCommentId = id;
            const booking = bookings.find(b => b.id === id);
            document.getElementById('commentsText').value = booking.comments || '';
            new bootstrap.Modal(document.getElementById('commentsModal')).show();
        }

        function saveComments() {
            const booking = bookings.find(b => b.id === currentCommentId);
            booking.comments = document.getElementById('commentsText').value;
            saveData();
            renderTable();
            bootstrap.Modal.getInstance(document.getElementById('commentsModal')).hide();
        }

        function deleteBooking(id) {
            if (!confirm('Delete this booking?')) return;
            bookings = bookings.filter(b => b.id !== id);
            saveData();
            renderTable();
        }

        function getFilteredBookings() {
            const tourCode = document.getElementById('filterTourCode').value.toLowerCase();
            const country = document.getElementById('filterCountry').value;
            const city = document.getElementById('filterCity').value;
            const hotel = document.getElementById('filterHotel').value.toLowerCase();
            const status = document.getElementById('filterStatus').value;
            const canxFrom = document.getElementById('filterCanxFrom').value;
            const canxTo = document.getElementById('filterCanxTo').value;

            return bookings.filter(b => {
                if (tourCode && !b.tourCode.toLowerCase().includes(tourCode)) return false;
                if (country && b.country !== country) return false;
                if (city && b.city !== city) return false;
                if (hotel && !b.hotelName.toLowerCase().includes(hotel)) return false;
                if (status && b.status !== status) return false;
                
                // Date range filter
                if (canxFrom || canxTo) {
                    if (!b.cancellationDeadline) return false;
                    const deadline = new Date(b.cancellationDeadline);
                    if (canxFrom && deadline < new Date(canxFrom)) return false;
                    if (canxTo && deadline > new Date(canxTo)) return false;
                }
                
                return true;
            });
        }

        function applyFilters() {
            renderTable();
        }

        function clearFilters() {
            document.getElementById('filterTourCode').value = '';
            document.getElementById('filterCountry').value = '';
            document.getElementById('filterCity').value = '';
            document.getElementById('filterHotel').value = '';
            document.getElementById('filterStatus').value = '';
            clearDateFilter();
        }

        function updateStats(filtered) {
            document.getElementById('statTotal').textContent = filtered.length;
            
            const totalRooms = filtered.reduce((sum, b) => {
                const matches = b.roomsConfig.match(/\d+/g);
                return sum + (matches ? matches.reduce((a, c) => a + parseInt(c), 0) : 0);
            }, 0);
            document.getElementById('statRooms').textContent = totalRooms;
            
            document.getElementById('statBlocked').textContent = filtered.filter(b => b.status === 'blocked').length;
            document.getElementById('statConfirmed').textContent = filtered.filter(b => b.status === 'confirmed').length;
            document.getElementById('statCancellation').textContent = filtered.filter(b => b.status === 'cancellation').length;
            document.getElementById('statCancelled').textContent = filtered.filter(b => b.status === 'cancelled').length;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-GB');
        }

        function saveData() {
            localStorage.setItem('hotelBookings', JSON.stringify(bookings));
        }

        function loadData() {
            const saved = localStorage.getItem('hotelBookings');
            if (saved) {
                bookings = JSON.parse(saved);
            }
        }

        function exportData() {
            const dataStr = JSON.stringify(bookings, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `hotel-tracker-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (confirm('Replace all data with imported file?')) {
                        bookings = imported;
                        saveData();
                        renderTable();
                        alert('Import successful');
                    }
                } catch (err) {
                    alert('Invalid file');
                }
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
